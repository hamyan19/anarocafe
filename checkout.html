<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ANARO ‚Äî Checkout</title>
  <style>
    :root{--bg:#fffdf9;--text:#2a221d;--muted:#6e625a;--border:#eadfd4;--brand:#7a4b2b}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:22px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .title{margin:0 0 8px 0;font-size:16px}
    label{font-size:13px;font-weight:700;color:#6b3f25}
    input[type="text"], input[type="email"], textarea{padding:10px;border:1px solid #0002;border-radius:10px;width:100%}
    input.required{border-color:#e74c3c}
    input.valid{border-color:#27ae60}
    .error{color:#e74c3c;font-size:12px;margin-top:4px}
    textarea{min-height:90px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .gender{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .opt{display:flex;gap:6px;align-items:center;padding:8px 10px;border:1px solid #0001;border-radius:10px;background:#0001;cursor:pointer}
    .line{display:flex;justify-content:space-between;margin:6px 0}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #0001;background:#0001;color:#1e1e1e;font-weight:800;cursor:pointer;text-decoration:none}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .cta{background:#F8EBDD;border-color:transparent}
    .loading{background:#ddd;color:#666}
    .srow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ico{width:18px;height:18px;display:inline-block}
    footer{margin-top:24px;color:#6e625a;font-size:12px;text-align:center}
    .toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#2a221d;color:#fff;padding:10px 14px;border-radius:10px;z-index:9999}

    /* Payment Methods - Updated styling for single option */
    .payment-methods{margin-top:12px}
    .payment-info{display:flex;gap:8px;align-items:center;padding:12px;border:1px solid var(--brand);border-radius:10px;background:#F8EBDD;margin-bottom:8px}
    .payment-info .ico{color:var(--brand)}

    /* Popup modal */
    .backdrop{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(520px,92vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 40px #0005;padding:16px}
    .modal h3{margin:0 0 6px}
    .modal p{margin:6px 0;color:var(--muted)}
    .modal .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .modal .btn{background:#0001}
    .modal .cta{background:#F8EBDD}

    /* Transfer info styling */
    .transfer-info{margin-top:12px}
    .bank-option{margin-bottom:12px;padding:12px;border:1px solid var(--border);border-radius:10px;background:#f9f9f9}
    .bank-header{font-weight:700;margin-bottom:8px;color:var(--brand)}
    .bank-details{font-size:14px}
    .detail-row{display:flex;justify-content:space-between;align-items:center;margin:4px 0}
    .copy-group{display:flex;align-items:center;gap:6px}
    .copy-btn{background:#F8EBDD;border:1px solid var(--border);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px}
    .copy-btn:hover{background:#e6d4c4}
    .transfer-amount{margin-top:16px;padding:12px;background:#fff3cd;border:1px solid #ffeaa7;border-radius:10px}
    .amount-info .detail-row{margin:6px 0}
  
    @media (max-width: 768px) {
      .grid{grid-template-columns:1fr}
      .row2{grid-template-columns:1fr}
      .gender{grid-template-columns:1fr 1fr}
      .srow{flex-direction:column}
      .modal{width:95vw}
      .detail-row{flex-direction:column;align-items:flex-start;gap:4px}
      .copy-group{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>‚òï ANARO COFFEE ‚Äî Thanh to√°n</h1>
      <a class="btn" href="index.html">‚Üê Ti·∫øp t·ª•c mua</a>
    </header>

    <div class="grid">
      <!-- LEFT: Customer Info -->
      <section class="card">
        <h2 class="title">Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h2>
        <div class="row2">
          <div>
            <label for="recipient">T√™n ng∆∞·ªùi nh·∫≠n *</label>
            <input id="recipient" type="text" placeholder="VD: Nguy·ªÖn VƒÉn A" required />
            <div class="error" id="recipientError"></div>
          </div>
          <div>
            <label>Gi·ªõi t√≠nh (x∆∞ng h√¥) *</label>
            <div class="gender">
              <label class="opt"><input type="radio" name="gender" value="Anh" checked /> Anh</label>
              <label class="opt"><input type="radio" name="gender" value="Ch·ªã" /> Ch·ªã</label>
              <label class="opt"><input type="radio" name="gender" value="Kh√°c" /> Kh√°c</label>
            </div>
          </div>
        </div>
        <div class="row2" style="margin-top:10px">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@example.com" />
            <div class="error" id="emailError"></div>
          </div>
          <div>
            <label for="phone">S·ªë ƒëi·ªán tho·∫°i *</label>
            <input id="phone" type="text" placeholder="09xx xxx xxx" required />
            <div class="error" id="phoneError"></div>
          </div>
        </div>
        <div style="margin-top:10px">
          <label for="address">ƒê·ªãa ch·ªâ *</label>
          <input id="address" type="text" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh" required />
          <div class="error" id="addressError"></div>
        </div>
        <div style="margin-top:10px">
          <label for="note">Ghi ch√∫</label>
          <textarea id="note" placeholder="Ghi ch√∫ th√™m (khung gi·ªù nh·∫≠n, ƒë·ªãa ch·ªâ chi ti·∫øt, v.v.)"></textarea>
        </div>

        <!-- Payment Methods - Only Transfer -->
        <h3 class="title" style="margin-top:14px">Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
        <div class="payment-methods">
          <div class="payment-info">
            <span class="ico">üì±</span>
            <span><strong>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong> - Momo/VCB/MBBank</span>
          </div>
          <input type="hidden" name="payment" value="transfer" />
        </div>

        <h3 class="title" style="margin-top:14px">Li√™n h·ªá / X√°c nh·∫≠n ƒë∆°n</h3>
        <div class="srow">
          <a id="linkZalo" class="btn" target="_blank" rel="noopener" href="#" aria-label="Zalo">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" ry="5" fill="#0068FF"/><text x="6.7" y="16.5" font-family="Segoe UI, Roboto, Helvetica, Arial" font-size="10" fill="#fff" font-weight="700">Z</text></svg>
            </span>
            <span>Zalo</span>
          </a>
          <a id="linkMsg" class="btn" target="_blank" rel="noopener" href="#" aria-label="Messenger">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#0099FF"/><path d="M6.5 14.2l4.1-3.1 3.1 3.1 3.3-3.1" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            <span>Messenger</span>
          </a>
          <a id="linkFan" class="btn" target="_blank" rel="noopener" href="#" aria-label="Fanpage Facebook">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="5" ry="5" fill="#1877F2"/><path d="M14 8h2V6h-2a3 3 0 0 0-3 3v2H9v2h2v5h2v-5h2l1-2h-3V9a1 1 0 0 1 1-1z" fill="#fff"/></svg>
            </span>
            <span>Fanpage</span>
          </a>
        </div>
      </section>

      <!-- RIGHT: Order Summary -->
      <section class="card">
        <h2 class="title">ƒê∆°n h√†ng</h2>
        <div class="line"><strong>Ti·ªÅn h√†ng</strong><span id="co-subtotal">0ƒë</span></div>
        <div class="line"><span>C√¢n n·∫∑ng</span><span id="co-weight">0 kg</span></div>
        <div class="line"><span>Ph√≠ ship</span><span id="co-ship">0ƒë</span></div>
        <div class="line"><strong>T·ªïng</strong><strong id="co-total">0ƒë</strong></div>
        <div class="muted" id="co-items" style="margin-top:8px"></div>
        <div style="margin-top:12px">
          <button id="placeOrder" class="btn cta">ƒê·∫∑t h√†ng</button>
        </div>
      </section>
    </div>

    <footer>ANARO COFFEE ¬∑ ¬© 2025</footer>
  </div>

  <!-- Success popup -->
  <div id="backdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="okTitle">
    <div class="modal">
      <h3 id="okTitle">üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng</h3>
      <p id="okSub">C·∫£m ∆°n b·∫°n! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá x√°c nh·∫≠n s·ªõm nh·∫•t.</p>
      <div class="row">
        <a class="btn" href="index.html">‚Üê Ti·∫øp t·ª•c mua</a>
        <a id="okZalo" class="btn" target="_blank" rel="noopener">Zalo</a>
        <a id="okMsg" class="btn" target="_blank" rel="noopener">Messenger</a>
        <a id="okFan" class="btn" target="_blank" rel="noopener">Fanpage</a>
      </div>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div id="qrBackdrop" class="backdrop" role="dialog" aria-modal="true">
    <div class="modal qr-modal">
      <h3>üí≥ Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
      <p>Vui l√≤ng chuy·ªÉn kho·∫£n theo th√¥ng tin b√™n d∆∞·ªõi:</p>
      
      <div class="transfer-info">
        <div class="bank-option">
          <div class="bank-header">üè¶ <strong>Vietcombank</strong></div>
          <div class="bank-details">
            <div class="detail-row">
              <span>S·ªë t√†i kho·∫£n:</span>
              <div class="copy-group">
                <code>0721000539033</code>
                <button class="copy-btn" onclick="copyToClipboard('0721000539033')">üìã</button>
              </div>
            </div>
            <div class="detail-row">
              <span>T√™n t√†i kho·∫£n:</span>
              <strong>H√Ä M·ª∏ AN</strong>
            </div>
          </div>
        </div>

        <div class="bank-option">
          <div class="bank-header">üèõÔ∏è <strong>MBBank</strong></div>
          <div class="bank-details">
            <div class="detail-row">
              <span>S·ªë t√†i kho·∫£n:</span>
              <div class="copy-group">
                <code>90919091986</code>
                <button class="copy-btn" onclick="copyToClipboard('90919091986')">üìã</button>
              </div>
            </div>
            <div class="detail-row">
              <span>T√™n t√†i kho·∫£n:</span>
              <strong>H√Ä M·ª∏ AN</strong>
            </div>
          </div>
        </div>

        <div class="bank-option">
          <div class="bank-header">üíú <strong>Momo</strong></div>
          <div class="bank-details">
            <div class="detail-row">
              <span>S·ªë ƒëi·ªán tho·∫°i:</span>
              <div class="copy-group">
                <code>0918337071</code>
                <button class="copy-btn" onclick="copyToClipboard('0918337071')">üìã</button>
              </div>
            </div>
            <div class="detail-row">
              <span>T√™n t√†i kho·∫£n:</span>
              <strong>ANARO COFFEE</strong>
            </div>
          </div>
        </div>

        <div class="transfer-amount">
          <div class="amount-info">
            <div class="detail-row">
              <span>S·ªë ti·ªÅn:</span>
              <strong id="transferAmount" style="color: #e74c3c; font-size: 18px;">0ƒë</strong>
            </div>
            <div class="detail-row">
              <span>N·ªôi dung:</span>
              <div class="copy-group">
                <code id="transferContent">ANARO ORDER</code>
                <button class="copy-btn" onclick="copyTransferContent()">üìã</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row" style="margin-top: 16px;">
        <button class="btn" onclick="hideQRModal()">‚Üê Quay l·∫°i</button>
        <button class="btn cta" onclick="confirmTransfer()">‚úì ƒê√£ chuy·ªÉn xong</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Config ======
    const FORM_EMAIL = "anmy1909@gmail.com"; 
    const FORM_ENDPOINT = "https://formsubmit.co/ajax/" + encodeURIComponent(FORM_EMAIL);
    
    // ‚ö†Ô∏è QUAN TR·ªåNG: Thay URL n√†y b·∫±ng URL Web App th·ª±c t·∫ø t·ª´ Google Apps Script
    // URL ph·∫£i c√≥ d·∫°ng: https://script.google.com/macros/s/[SCRIPT_ID]/exec
    const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbzNeAQvdDfass4qKYdS2C3PZtIVdRhlQp3rICd2a8H4f5qhOeGaq6dEvfiROLue2qjARA/exec";
    
    // Social links
    const SOCIAL_LINKS = {
      zalo: "https://zalo.me/84918337071",
      messenger: "https://m.me/anarocoffee",
      fanpage: "https://www.facebook.com/anarocoffee/"
    };

    // ====== Helpers ======
    const fmt = n => (n||0).toLocaleString('vi-VN') + "ƒë";
    
    function showToast(msg, type = 'info'){
      const t = document.createElement('div'); 
      t.className = 'toast'; 
      t.textContent = msg; 
      if(type === 'error') t.style.background = '#e74c3c';
      if(type === 'success') t.style.background = '#27ae60';
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 3000);
    }

    function showPopup(){
      document.getElementById('backdrop').style.display = 'flex';
    }

    function hidePopup(){
      document.getElementById('backdrop').style.display = 'none';
    }

    function showQRModal(){
      const payload = readPayloadFromHash();
      const total = payload ? payload.total : 0;
      const orderCode = 'ANARO' + Date.now().toString().slice(-6);
      
      // Update transfer amount and content
      document.getElementById('transferAmount').textContent = fmt(total);
      document.getElementById('transferContent').textContent = orderCode;
      
      document.getElementById('qrBackdrop').style.display = 'flex';
    }

    function hideQRModal(){
      document.getElementById('qrBackdrop').style.display = 'none';
    }

    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('‚úÖ ƒê√£ copy: ' + text, 'success');
        }).catch(() => {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        showToast('‚úÖ ƒê√£ copy: ' + text, 'success');
      } catch (err) {
        showToast('‚ùå Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.', 'error');
      }
      document.body.removeChild(textArea);
    }

    function copyTransferContent() {
      const content = document.getElementById('transferContent').textContent;
      copyToClipboard(content);
    }

    function confirmTransfer(){
      hideQRModal();
      processOrder();
    }

    // Event listeners for modals
    document.getElementById('backdrop').addEventListener('click', (e)=>{
      if(e.target.id==='backdrop') hidePopup();
    });
    
    document.getElementById('qrBackdrop').addEventListener('click', (e)=>{
      if(e.target.id==='qrBackdrop') hideQRModal();
    });

    function readPayloadFromHash(){
      try{
        const m = location.hash.match(/[#&]p=([^&]+)/);
        if(!m) return null;
        const json = decodeURIComponent(escape(atob(m[1])));
        return JSON.parse(json);
      }catch(e){ 
        console.log('No payload found in hash, using default values');
        return {
          items: [{name: 'Arabica ƒê√† L·∫°t', size: '250g', grind: 'Nguy√™n h·∫°t', qty: 2}],
          subtotal: 180000,
          weightKg: 0.5,
          shipping: 29000,
          total: 209000
        };
      }
    }

    function bindSocialLinks(){
      document.getElementById('linkZalo').href = SOCIAL_LINKS.zalo;
      document.getElementById('linkMsg').href  = SOCIAL_LINKS.messenger;
      document.getElementById('linkFan').href  = SOCIAL_LINKS.fanpage;

      document.getElementById('okZalo').href = SOCIAL_LINKS.zalo;
      document.getElementById('okMsg').href  = SOCIAL_LINKS.messenger;
      document.getElementById('okFan').href  = SOCIAL_LINKS.fanpage;
    }

    function renderOrderSummary(payload){
      if(!payload) return;
      const { items=[], subtotal=0, weightKg=0, shipping=0, total=0 } = payload;
      document.getElementById('co-subtotal').textContent = fmt(subtotal);
      document.getElementById('co-weight').textContent   = (weightKg||0).toFixed(2) + " kg";
      document.getElementById('co-ship').textContent     = fmt(shipping);
      document.getElementById('co-total').textContent    = fmt(total);
      const lines = items.map(it => `‚Ä¢ ${it.name} ‚Äî ${it.size} ‚Äî ${it.grind} √ó ${it.qty}`).join('<br>');
      document.getElementById('co-items').innerHTML = lines || '';
    }

    function validateForm(){
      let isValid = true;
      const errors = {};

      // Validate required fields
      const name = document.getElementById('recipient').value.trim();
      if(!name) {
        errors.recipient = 'T√™n ng∆∞·ªùi nh·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
        isValid = false;
      }

      const phone = document.getElementById('phone').value.trim();
      if(!phone) {
        errors.phone = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
        isValid = false;
      } else if(!/^0[0-9]{9,10}$/.test(phone.replace(/\s/g, ''))) {
        errors.phone = 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 0 v√† c√≥ 10-11 ch·ªØ s·ªë';
        isValid = false;
      }

      const address = document.getElementById('address').value.trim();
      if(!address) {
        errors.address = 'ƒê·ªãa ch·ªâ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
        isValid = false;
      }

      // Validate email if provided
      const email = document.getElementById('email').value.trim();
      if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        errors.email = 'Email kh√¥ng h·ª£p l·ªá';
        isValid = false;
      }

      // Display errors and update UI
      Object.keys(errors).forEach(field => {
        const errorEl = document.getElementById(field + 'Error');
        const inputEl = document.getElementById(field);
        if(errorEl) errorEl.textContent = errors[field];
        if(inputEl) {
          inputEl.classList.remove('valid');
          inputEl.classList.add('required');
        }
      });

      // Clear errors for valid fields and mark as valid
      ['recipient', 'phone', 'address', 'email'].forEach(field => {
        if(!errors[field]) {
          const errorEl = document.getElementById(field + 'Error');
          const inputEl = document.getElementById(field);
          if(errorEl) errorEl.textContent = '';
          if(inputEl) {
            inputEl.classList.remove('required');
            if(inputEl.value.trim()) {
              inputEl.classList.add('valid');
            } else {
              inputEl.classList.remove('valid');
            }
          }
        }
      });

      return isValid;
    }

    function getFormData(){
      const name = document.getElementById('recipient').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const note = document.getElementById('note').value.trim();
      const gender = document.querySelector('input[name="gender"]:checked')?.value || 'Anh';
      const payment = 'transfer'; // Always transfer now
      
      return { name, email, phone, address, note, gender, payment };
    }

    // Real-time validation for phone number
    function setupRealTimeValidation() {
      const phoneInput = document.getElementById('phone');
      
      phoneInput.addEventListener('input', function() {
        const phone = this.value.trim();
        const errorEl = document.getElementById('phoneError');
        
        if(!phone) {
          this.classList.remove('valid', 'required');
          errorEl.textContent = '';
        } else if(!/^0[0-9]{9,10}$/.test(phone.replace(/\s/g, ''))) {
          this.classList.remove('valid');
          this.classList.add('required');
          errorEl.textContent = 'S·ªë ƒëi·ªán tho·∫°i ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng 0 v√† c√≥ 10-11 ch·ªØ s·ªë';
        } else {
          this.classList.remove('required');
          this.classList.add('valid');
          errorEl.textContent = '';
        }
      });

      // Real-time validation for other required fields
      ['recipient', 'address'].forEach(fieldId => {
        const input = document.getElementById(fieldId);
        input.addEventListener('input', function() {
          const value = this.value.trim();
          const errorEl = document.getElementById(fieldId + 'Error');
          
          if(!value) {
            this.classList.remove('valid', 'required');
            errorEl.textContent = '';
          } else {
            this.classList.remove('required');
            this.classList.add('valid');
            errorEl.textContent = '';
          }
        });
      });

      // Email validation
      const emailInput = document.getElementById('email');
      emailInput.addEventListener('input', function() {
        const email = this.value.trim();
        const errorEl = document.getElementById('emailError');
        
        if(!email) {
          this.classList.remove('valid', 'required');
          errorEl.textContent = '';
        } else if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          this.classList.remove('valid');
          this.classList.add('required');
          errorEl.textContent = 'Email kh√¥ng h·ª£p l·ªá';
        } else {
          this.classList.remove('required');
          this.classList.add('valid');
          errorEl.textContent = '';
        }
      });
    }

    // Fixed JSONP function ƒë·ªÉ tr√°nh CORS
    function sendToGoogleSheets(orderData) {
      return new Promise((resolve, reject) => {
        try {
          const callbackName = 'googleSheetsCallback_' + Date.now();
          const script = document.createElement('script');
          
          window[callbackName] = function(response) {
            // Cleanup
            delete window[callbackName];
            if (script.parentNode) {
              document.head.removeChild(script);
            }
            
            console.log('üìä Google Sheets response:', response);
            
            if (response && (response.success || response.result === 'success')) {
              resolve(response);
            } else {
              reject(new Error(response ? (response.message || response.error || 'Unknown error') : 'Unknown error from Google Sheets'));
            }
          };
          
          script.onerror = function() {
            delete window[callbackName];
            if (script.parentNode) {
              document.head.removeChild(script);
            }
            reject(new Error('JSONP request failed - network error'));
          };
          
          // T·∫°o URL v·ªõi callback v√† data
          const params = new URLSearchParams({
            callback: callbackName,
            data: JSON.stringify(orderData)
          });
          
          script.src = `${GOOGLE_SHEETS_URL}?${params.toString()}`;
          document.head.appendChild(script);
          
          // Timeout sau 15 gi√¢y
          setTimeout(() => {
            if (window[callbackName]) {
              delete window[callbackName];
              if (script.parentNode) {
                document.head.removeChild(script);
              }
              reject(new Error('Request timeout - Google Sheets kh√¥ng ph·∫£n h·ªìi'));
            }
          }, 15000);
          
        } catch (error) {
          reject(error);
        }
      });
    }

    async function sendOrderByEmail(orderData){
      try {
        const r = orderData.recipient || {};
        const itemsStr = (orderData.items||[]).map(i=>`${i.name} ‚Äî ${i.size} ‚Äî ${i.grind} √ó ${i.qty}`).join("; ");
        
        const body = {
          _subject: "ƒê∆°n h√†ng m·ªõi t·ª´ ANARO COFFEE",
          _template: "table",
          _captcha: false,
          _next: window.location.href,
          "Ng∆∞·ªùi nh·∫≠n": `${r.gender||""} ${r.name||""}`.trim(),
          "Email": r.email||"N/A",
          "SƒêT": r.phone||"",
          "ƒê·ªãa ch·ªâ": r.address||"",
          "Ghi ch√∫": r.note||"N/A",
          "Ph∆∞∆°ng th·ª©c TT": "Chuy·ªÉn kho·∫£n",
          "Ti·ªÅn h√†ng": fmt(orderData.subtotal||0),
          "Ph√≠ ship": fmt(orderData.shipping||0),
          "T·ªïng": fmt(orderData.total||0),
          "C√¢n n·∫∑ng (kg)": (orderData.weightKg||0),
          "Chi ti·∫øt": itemsStr,
          "M√£ ƒë∆°n": orderData.orderCode || 'N/A',
          "Th·ªùi gian": new Date().toLocaleString('vi-VN')
        };

        console.log('üìß Sending email with data:', body);

        const res = await fetch(FORM_ENDPOINT, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json", 
            "Accept": "application/json" 
          },
          body: JSON.stringify(body)
        });

        console.log('üìß Email response status:', res.status);
        
        if(!res.ok) { 
          const errorText = await res.text();
          console.error('üìß Email error response:', errorText);
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const result = await res.json().catch(()=>({}));
        console.log('üìß Email success response:', result);
        return result;
      } catch (error) {
        console.error('üìß Email sending failed:', error);
        throw error;
      }
    }

    async function processOrder() {
      const orderBtn = document.getElementById('placeOrder');
      
      try {
        // Disable button and show loading
        orderBtn.disabled = true;
        orderBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
        orderBtn.classList.add('loading');

        const payload = readPayloadFromHash() || {};
        const formData = getFormData();
        
        const orderData = {
          ...payload,
          recipient: formData,
          contact: { ...SOCIAL_LINKS },
          orderTime: new Date().toISOString(),
          orderCode: 'ANARO' + Date.now().toString().slice(-6)
        };

        console.log('üöÄ Processing order:', orderData);

        let sheetsSuccess = false;
        let emailSuccess = false;
        let sheetsError = null;
        let emailError = null;

        // Try Google Sheets first
        try {
          console.log('üìä Attempting Google Sheets...');
          const sheetsResult = await sendToGoogleSheets(orderData);
          console.log('‚úÖ Google Sheets success:', sheetsResult);
          sheetsSuccess = true;
        } catch (error) {
          console.error('‚ùå Google Sheets failed:', error);
          sheetsError = error;
        }

        // Try email as backup
        try {
          console.log('üìß Attempting email backup...');
          const emailResult = await sendOrderByEmail(orderData);
          console.log('‚úÖ Email backup success:', emailResult);
          emailSuccess = true;
        } catch (error) {
          console.error('‚ùå Email backup failed:', error);
          emailError = error;
        }

        // Show success if at least one method worked
        if (sheetsSuccess || emailSuccess) {
          // Clear form
          document.getElementById('recipient').value = '';
          document.getElementById('email').value = '';
          document.getElementById('phone').value = '';
          document.getElementById('address').value = '';
          document.getElementById('note').value = '';
          
          // Clear validation classes
          ['recipient', 'email', 'phone', 'address'].forEach(fieldId => {
            const input = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + 'Error');
            if(input) input.classList.remove('valid', 'required');
            if(error) error.textContent = '';
          });
          
          // Reset gender to default
          document.querySelector('input[name="gender"][value="Anh"]').checked = true;
          
          // Show success popup
          showPopup();
          showToast('‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!', 'success');
          
          if (sheetsSuccess) {
            console.log('üìä ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o Google Sheets');
          }
          if (emailSuccess) {
            console.log('üìß ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i qua email');
          }
        } else {
          let errorMsg = 'Kh√¥ng th·ªÉ x·ª≠ l√Ω ƒë∆°n h√†ng. ';
          if (sheetsError) errorMsg += `Google Sheets: ${sheetsError.message}. `;
          if (emailError) errorMsg += `Email: ${emailError.message}. `;
          errorMsg += 'Vui l√≤ng li√™n h·ªá tr·ª±c ti·∫øp qua Zalo/Messenger.';
          
          throw new Error(errorMsg);
        }
        
      } catch(err) {
        console.error('üí• Order processing error:', err);
        showToast(err.message || "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá tr·ª±c ti·∫øp qua Zalo/Messenger.", 'error');
      } finally {
        // Re-enable button
        orderBtn.disabled = false;
        orderBtn.textContent = 'ƒê·∫∑t h√†ng';
        orderBtn.classList.remove('loading');
      }
    }

    document.getElementById('placeOrder').addEventListener('click', async ()=>{
      if(!validateForm()) {
        showToast("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc v√† ki·ªÉm tra l·∫°i s·ªë ƒëi·ªán tho·∫°i", 'error');
        return;
      }

      // Since we only have transfer payment method now, always show QR modal
      showQRModal();
    });

    // Initialize
    (function init(){
      bindSocialLinks();
      renderOrderSummary(readPayloadFromHash());
      setupRealTimeValidation();
    })();
  </script>
</body>
</html>
